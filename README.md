# OUSD Harvester
A simple long-tail MEV bot that harvests [OUSD](https://www.ousd.com/) strategies whenever profitable.
## Setup 
1. `git clone https://github.com/onlamp/ousd-harvester`
2. `cd ousd-harvester`
3. `npm i`
4. Create a `.env` file (reference `.env.example`)
5. **OPTIONAL**: Add any new strategies listed in the [OUSD documentation](https://docs.oeth.com/smart-contracts/registry/ousd-registry) to `src/data/strategies.ts`
6. `npm run bot` 

**NOTE: This bot probably won't earn you anything. Use at your own risk.**

## The Opportunity 
OUSD is a rebasing stable coin that uses DeFi strategies to generate yield. These strategies have a `harvestAndSwap()` function that handles the rewards from said strategies, and **sends a percentage of the rewards to anyone who calls the function**.

When the reward to call the function is greater than the gas cost, you can earn a profit. The reward increases each block, as more rewards are accrued by the strategies. After the function is called, the reward resets to 0 and you need to wait for it to build up again.

Additionally, the harvest transaction can contain large swaps, so we can opt to send to services like [MEV-Share](https://docs.flashbots.net/flashbots-protect/rpc/mev-share) or [MEVBlocker](https://mevblocker.io/) to potentially earn additional ETH rebates from backrun opportunities generated by the harvest tx.

Example:
- [Harvest transaction with a 15 USDT profit](https://etherscan.io/tx/0xb2c1d7db36095fbc9a2d345efaf3a930bf5198afd6017a26cc1fdfe32467d83c) and an additional $30 profit from a [MEVBlocker rebate](https://etherscan.io/tx/0xadf5ffa815daf5baff8d44f633f42298026740629a18c5ae6fc79834ef7b2b42).


## Flow
On each new block, for each strategy (defined in `src/data/strategies.ts`):

 1. Determine the reward (USDT) for calling `harvestAndSwap()`
 2. Simulate a `harvestAndSwap()` transaction with the `eth_callBundle` method, sending to either a [mev-geth](https://github.com/flashbots/mev-geth) node or the Flashbots relay
 3. If the simulation succeeds, calculate the cost of the transaction
 4. The profit is equal to `reward - ((fee + bribe) * gas used)`. If profit > `MINIMUM_PROFIT`, send the harvest transaction to [MEVBlocker](https://mevblocker.io/).
 ## Contract (`contracts/helper.sol)`:
 Functions:
 - `randallAteMySandwich_dbohban()` - Harvest function (Leading 0 function selector to save gas, pulled from [4byte.directory](https://www.4byte.directory/) - hence the odd name). Calls `harvestAndSwap()` and then performs a balance check to ensure that you received the expected reward. This is useful if both you and a competitor send a harvest TX targeting the same block and their transaction ends up before yours. Your transaction would revert, and ultimately would never land on chain as we send to a no reverts endpoint.
 - `getCallReward()` - Function to get the reward from harvesting a strategy.
## Potential Improvements
- Support [OETH](https://www.oeth.com/), an ETH version of OUSD that has the same call reward mechanism, but a different harvester contract. 
	- You could modify and redeploy `contracts/helper.sol` with a `harvester` param in the harvest function to specify which harvester to use.  OR send the transaction directly to the [harvester](https://etherscan.io/address/0x0D017aFA83EAce9F10A8EC5B6E13941664A6785C) contract (however, you lose the revert advantage mentioned above)
- Instead of using a helper contract to find the harvest reward, use `debug_traceCall` with `diffMode`, and examine your USDT balance before and after to calculate the reward.
